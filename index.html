<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã T√¢ches d'√©quipe</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{min-height:100vh;background:linear-gradient(135deg,#0f172a,#1e293b);font-family:'Segoe UI',sans-serif;padding:20px 16px;color:#f1f5f9}
.container{max-width:680px;margin:0 auto}
h1{font-size:24px;margin-bottom:6px}
.stats{color:#94a3b8;font-size:13px;margin-bottom:10px}
.stats .overdue{color:#ef4444;font-weight:600;margin-left:12px}
.bar-bg{background:#334155;border-radius:999px;height:7px;overflow:hidden;margin-bottom:18px}
.bar-fill{height:100%;border-radius:999px;transition:width .4s}
.panel{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:14px;margin-bottom:14px}
.row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;align-items:center}
.row:last-child{margin-bottom:0}
input,select{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#f1f5f9;font-size:13px;outline:none}
input:focus{border-color:#3b82f6}
select{cursor:pointer;font-size:12px}
.inp-flex{flex:1;min-width:0}
button{border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:opacity .2s}
button:hover{opacity:.85}
.btn-add{padding:10px 20px;background:#3b82f6;color:#fff;font-size:16px;flex-shrink:0}
.btn-filter{flex:1;padding:7px 0;font-size:12px;border-radius:10px}
.btn-filter.active{background:#3b82f6;color:#fff}
.btn-filter:not(.active){background:#0f172a;color:#94a3b8}
.cat-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
.btn-cat{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600}
.btn-cat.active{background:#8b5cf6;color:#fff}
.btn-cat:not(.active){background:#0f172a;color:#64748b}
.person-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px}
.btn-person{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600}
.btn-person.active{background:#f59e0b;color:#fff}
.btn-person:not(.active){background:#0f172a;color:#64748b}
.task{border-radius:14px;border:1px solid #334155;margin-bottom:8px;overflow:hidden;transition:all .3s}
.task.done{opacity:1;background:#1e293b;border-color:#22c55e55}
.task:not(.done){background:#1e293b}
.task.overdue{border-color:#ef444466}
.task-main{display:flex;align-items:flex-start;gap:10px;padding:12px 14px}
.check{width:22px;height:22px;border-radius:7px;border:2px solid #475569;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;margin-top:2px;user-select:none}
.check.checked{border-color:#22c55e;background:#22c55e;color:#fff}
.task-body{flex:1;min-width:0}
.task-title{font-size:13px;word-break:break-word}
.task-title.crossed{text-decoration:none}
.task-meta{display:flex;gap:6px;margin-top:5px;font-size:10px;color:#64748b;flex-wrap:wrap;align-items:center}
.badge-cat{background:#8b5cf622;color:#a78bfa;padding:1px 7px;border-radius:6px;font-weight:600}
.badge-person{background:#3b82f622;color:#60a5fa;padding:1px 7px;border-radius:6px}
.badge-date.overdue{color:#ef4444;font-weight:600}
.badge-date.soon{color:#f59e0b}
.btn-del{background:none;color:#ef4444;font-size:15px;padding:2px 6px;opacity:.5;flex-shrink:0;margin-top:2px}
.btn-del:hover{opacity:1}
.btn-edit{background:none;color:#64748b;font-size:13px;padding:2px 6px;flex-shrink:0;margin-top:2px}
.edit-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.edit-row input,.edit-row select{font-size:11px;padding:6px 10px}
.btn-sm{padding:5px 12px;font-size:11px;color:#fff;border-radius:8px}
.empty{text-align:center;color:#64748b;padding:32px;font-size:13px}
.comment-section{border-top:1px solid #334155;padding:10px 14px;background:#0f172a}
.comment{margin-bottom:8px;padding:6px 10px;background:#1e293b;border-radius:8px}
.comment-meta{font-size:10px;color:#64748b;margin-bottom:3px}
.comment-text{font-size:12px;color:#e2e8f0}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:80vh}
.login-box{background:#1e293b;border:1px solid #334155;border-radius:20px;padding:40px;max-width:420px;width:100%;text-align:center}
.login-box input{width:100%;margin-bottom:12px;padding:14px 18px;font-size:15px}
.login-box button{width:100%;padding:14px;font-size:16px;border-radius:10px}
.login-err{color:#ef4444;font-size:13px;margin-bottom:12px}
.toast{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#fff;padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;opacity:0;transition:opacity .3s;pointer-events:none;z-index:999}
.toast.show{opacity:1}
.header-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.user-info{display:flex;align-items:center;gap:10px}
.user-info span{color:#94a3b8;font-size:13px}
.btn-logout{padding:5px 10px;background:#334155;color:#94a3b8;font-size:11px;border-radius:8px}
.online-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:4px}
.loading{text-align:center;color:#94a3b8;padding:60px;font-size:16px}
.bulk-bar{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.btn-bulk{padding:6px 14px;font-size:11px;border-radius:8px;color:#fff}
.bulk-info{color:#94a3b8;font-size:11px}
.pagination{display:flex;align-items:center;justify-content:center;gap:10px;margin:12px 0}
.pagination button{padding:6px 14px;background:#334155;color:#94a3b8;font-size:12px;border-radius:8px}
.pagination button:disabled{opacity:.3;cursor:not-allowed}
.pagination span{color:#94a3b8;font-size:12px}
</style>
</head>
<body>
<div class="container" id="app"><div class="loading">‚è≥ Chargement...</div></div>
<div class="toast" id="toast"></div>

<script>
// Firebase config
firebase.initializeApp({
  apiKey: "AIzaSyAVHMM4i3dujtxINjxui9QwXNz9sqZ9uKU",
  authDomain: "todo-equipe.firebaseapp.com",
  databaseURL: "https://todo-equipe-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "todo-equipe",
  storageBucket: "todo-equipe.firebasestorage.app",
  messagingSenderId: "863525528448",
  appId: "1:863525528448:web:e0901ce9cd1dfdbc9ed765"
});

var auth = firebase.auth();
var db = firebase.database();

var state = {
  user: null,
  userName: "",
  tasks: {},
  users: {},
  categories: ["Travail", "Personnel", "QA", "Dev", "Urgent", "Autre"],
  filter: "Toutes",
  catFilter: "Toutes",
  personFilter: "Toutes",
  editId: null,
  commentOpenId: null,
  showNewCat: false,
  loginMode: "login",
  loginErr: "",
  page: 0
};

var PRIORITIES = { high: "üî¥ Haute", medium: "üü° Moyenne", low: "üü¢ Basse" };
var FILTERS = ["Toutes", "√Ä faire", "Termin√©es"];
var PAGE_SIZE = 50;

// ========== AUTH ==========
auth.onAuthStateChanged(function(u) {
  if (u) {
    state.user = u;
    // Get or set user name
    db.ref("users/" + u.uid).once("value", function(snap) {
      var data = snap.val();
      if (data && data.name) {
        state.userName = data.name;
      } else {
        state.userName = u.email.split("@")[0];
        db.ref("users/" + u.uid).set({ name: state.userName, email: u.email });
      }
      listenData();
      render();
    });
  } else {
    state.user = null;
    state.userName = "";
    state.tasks = {};
    render();
  }
});

function doLogin() {
  var em = document.getElementById("loginEmail");
  var pw = document.getElementById("loginPass");
  if (!em || !pw || !em.value || !pw.value) return;
  state.loginErr = "";
  auth.signInWithEmailAndPassword(em.value, pw.value).catch(function(e) {
    state.loginErr = "Email ou mot de passe incorrect";
    render();
  });
}

function doRegister() {
  var em = document.getElementById("loginEmail");
  var pw = document.getElementById("loginPass");
  var nm = document.getElementById("loginName");
  if (!em || !pw || !em.value || !pw.value) return;
  state.loginErr = "";
  auth.createUserWithEmailAndPassword(em.value, pw.value).then(function(cred) {
    var name = (nm && nm.value.trim()) ? nm.value.trim() : em.value.split("@")[0];
    db.ref("users/" + cred.user.uid).set({ name: name, email: em.value });
  }).catch(function(e) {
    if (e.code === "auth/email-already-in-use") state.loginErr = "Cet email est d√©j√† utilis√©";
    else if (e.code === "auth/weak-password") state.loginErr = "Mot de passe trop faible (min 6 caract√®res)";
    else state.loginErr = "Erreur : " + e.message;
    render();
  });
}

function doLogout() { auth.signOut(); }

// ========== REALTIME LISTENERS ==========
function listenData() {
  db.ref("tasks").on("value", function(snap) {
    state.tasks = snap.val() || {};
    render();
  });
  db.ref("users").on("value", function(snap) {
    state.users = snap.val() || {};
    render();
  });
  db.ref("categories").on("value", function(snap) {
    var c = snap.val();
    if (c && c.length) state.categories = c;
    render();
  });
}

// ========== HELPERS ==========
function esc(s) { var d = document.createElement("div"); d.textContent = s || ""; return d.innerHTML; }
function escQuote(s) { return esc(s).replace(/'/g, "&#39;"); }
function isOverdue(t) { return t.dueDate && !t.done && new Date(t.dueDate) < new Date(new Date().toDateString()); }
function isDueSoon(t) { if (!t.dueDate || t.done) return false; var d = (new Date(t.dueDate) - new Date(new Date().toDateString())) / 86400000; return d >= 0 && d <= 2; }
function fmtDate(d) { return d ? new Date(d).toLocaleDateString("fr-FR", { day: "numeric", month: "short" }) : ""; }
function fmtFull(d) { return d ? new Date(d).toLocaleDateString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" }) : ""; }
function getUserName(uid) { return (state.users[uid] && state.users[uid].name) ? state.users[uid].name : "?"; }
function toast(msg) { var t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(function() { t.classList.remove("show"); }, 1500); }

// ========== ACTIONS ==========
function addTask() {
  var txt = document.getElementById("newTask");
  var pri = document.getElementById("newPriority");
  var cat = document.getElementById("newCategory");
  var due = document.getElementById("newDue");
  var asg = document.getElementById("newAssignee");
  if (!txt || !txt.value.trim()) return;
  var key = db.ref("tasks").push().key;
  db.ref("tasks/" + key).set({
    text: txt.value.trim(),
    done: false,
    priority: pri ? pri.value : "medium",
    category: cat ? cat.value : "Travail",
    dueDate: (due && due.value) ? due.value : null,
    assignee: (asg && asg.value) ? asg.value : null,
    createdBy: state.user.uid,
    completedBy: null,
    createdAt: new Date().toISOString(),
    comments: {}
  });
  toast("‚úÖ T√¢che ajout√©e");
}

function toggleTask(id) {
  var t = state.tasks[id];
  if (!t) return;
  var updates = { done: !t.done, completedBy: !t.done ? state.user.uid : null, completedAt: !t.done ? new Date().toISOString() : null };
  db.ref("tasks/" + id).update(updates);
}

function removeTask(id) {
  if (!confirm("Supprimer cette t√¢che ?")) return;
  db.ref("tasks/" + id).remove();
  toast("üóëÔ∏è Supprim√©e");
}

function startEdit(id) { state.editId = id; render(); }
function cancelEdit() { state.editId = null; render(); }
function saveEdit(id) {
  var txt = document.getElementById("editText");
  var cat = document.getElementById("editCat");
  var due = document.getElementById("editDue");
  var asg = document.getElementById("editAssignee");
  if (!txt || !txt.value.trim()) return;
  db.ref("tasks/" + id).update({
    text: txt.value.trim(),
    category: cat ? cat.value : "Travail",
    dueDate: (due && due.value) ? due.value : null,
    assignee: (asg && asg.value) ? asg.value : null
  });
  state.editId = null;
  toast("‚úÖ Modifi√©e");
}

function showAddCat() { state.showNewCat = !state.showNewCat; render(); }
function addCategory() {
  var i = document.getElementById("newCatName");
  if (!i || !i.value.trim()) return;
  var name = i.value.trim();
  if (state.categories.indexOf(name) === -1) {
    state.categories.push(name);
    db.ref("categories").set(state.categories);
  }
  state.showNewCat = false;
  render();
}

function toggleComments(id) { state.commentOpenId = (state.commentOpenId === id) ? null : id; render(); }
function addComment(taskId) {
  var i = document.getElementById("cmtIn" + taskId);
  if (!i || !i.value.trim()) return;
  db.ref("tasks/" + taskId + "/comments").push({
    author: state.user.uid,
    text: i.value.trim(),
    at: new Date().toISOString()
  });
  toast("üí¨ Commentaire ajout√©");
}

function setFilter(f) { state.filter = f; state.page = 0; render(); }
function setCatFilter(c) { state.catFilter = c; state.page = 0; render(); }
function setPersonFilter(p) { state.personFilter = p; state.page = 0; render(); }
function setLoginMode(m) { state.loginMode = m; state.loginErr = ""; render(); }
function goPage(p) { state.page = p; render(); window.scrollTo(0, 0); }

function selectAll() {
  var taskArr = [];
  for (var k in state.tasks) { var t = state.tasks[k]; t._id = k; taskArr.push(t); }
  var toUpdate = [];
  for (var i = 0; i < taskArr.length; i++) {
    var t = taskArr[i];
    var pF = state.filter === "Toutes" || (state.filter === "√Ä faire" && !t.done) || (state.filter === "Termin√©es" && t.done);
    var pC = state.catFilter === "Toutes" || t.category === state.catFilter;
    var pP = state.personFilter === "Toutes" || t.assignee === state.personFilter || t.createdBy === state.personFilter;
    if (pF && pC && pP && !t.done) toUpdate.push(t._id);
  }
  if (toUpdate.length === 0) { toast("Aucune t√¢che √† cocher"); return; }
  var updates = {};
  for (var i = 0; i < toUpdate.length; i++) {
    updates[toUpdate[i] + "/done"] = true;
    updates[toUpdate[i] + "/completedBy"] = state.user.uid;
    updates[toUpdate[i] + "/completedAt"] = new Date().toISOString();
  }
  db.ref("tasks").update(updates);
  toast("‚úÖ " + toUpdate.length + " t√¢ches coch√©es");
}

function deselectAll() {
  var taskArr = [];
  for (var k in state.tasks) { var t = state.tasks[k]; t._id = k; taskArr.push(t); }
  var toUpdate = [];
  for (var i = 0; i < taskArr.length; i++) {
    var t = taskArr[i];
    var pF = state.filter === "Toutes" || (state.filter === "√Ä faire" && !t.done) || (state.filter === "Termin√©es" && t.done);
    var pC = state.catFilter === "Toutes" || t.category === state.catFilter;
    var pP = state.personFilter === "Toutes" || t.assignee === state.personFilter || t.createdBy === state.personFilter;
    if (pF && pC && pP && t.done) toUpdate.push(t._id);
  }
  if (toUpdate.length === 0) { toast("Aucune t√¢che √† d√©cocher"); return; }
  var updates = {};
  for (var i = 0; i < toUpdate.length; i++) {
    updates[toUpdate[i] + "/done"] = false;
    updates[toUpdate[i] + "/completedBy"] = null;
    updates[toUpdate[i] + "/completedAt"] = null;
  }
  db.ref("tasks").update(updates);
  toast("‚Ü©Ô∏è " + toUpdate.length + " t√¢ches d√©coch√©es");
}

// ========== RENDER ==========
function render() {
  var app = document.getElementById("app");
  if (!state.user) { renderLogin(app); return; }

  var taskArr = [];
  for (var k in state.tasks) { var t = state.tasks[k]; t._id = k; taskArr.push(t); }

  var doneCount = 0, overdueCount = 0;
  for (var i = 0; i < taskArr.length; i++) { if (taskArr[i].done) doneCount++; if (isOverdue(taskArr[i])) overdueCount++; }
  var pct = taskArr.length ? Math.round((doneCount / taskArr.length) * 100) : 0;

  var filtered = [];
  for (var i = 0; i < taskArr.length; i++) {
    var t = taskArr[i];
    var pF = state.filter === "Toutes" || (state.filter === "√Ä faire" && !t.done) || (state.filter === "Termin√©es" && t.done);
    var pC = state.catFilter === "Toutes" || t.category === state.catFilter;
    var pP = state.personFilter === "Toutes" || t.assignee === state.personFilter || t.createdBy === state.personFilter;
    if (pF && pC && pP) filtered.push(t);
  }

  var po = { high: 0, medium: 1, low: 2 };
  filtered.sort(function(a, b) { return po[a.priority] - po[b.priority]; });

  var catSet = {};
  for (var i = 0; i < taskArr.length; i++) catSet[taskArr[i].category] = true;
  var usedCats = ["Toutes"];
  for (var c in catSet) usedCats.push(c);

  var catOpts = "", priOpts = "";
  for (var i = 0; i < state.categories.length; i++) catOpts += '<option value="' + esc(state.categories[i]) + '">' + esc(state.categories[i]) + '</option>';
  for (var k in PRIORITIES) priOpts += '<option value="' + k + '">' + PRIORITIES[k] + '</option>';

  var userOpts = '<option value="">Non assign√©e</option>';
  var allPeople = ["Toutes"];
  for (var uid in state.users) {
    var nm = state.users[uid].name || uid;
    userOpts += '<option value="' + uid + '">' + esc(nm) + '</option>';
    allPeople.push(uid);
  }

  var h = '';

  // Header
  h += '<div class="header-bar"><h1>üìã T√¢ches d\'√©quipe</h1>';
  h += '<div class="user-info"><span><span class="online-dot"></span>' + esc(state.userName) + '</span>';
  h += '<button class="btn-logout" onclick="doLogout()">D√©connexion</button></div></div>';

  // Stats
  h += '<div class="stats">' + doneCount + '/' + taskArr.length + ' termin√©es ‚Äî ' + pct + '%';
  if (overdueCount > 0) h += '<span class="overdue">‚ö†Ô∏è ' + overdueCount + ' en retard</span>';
  h += '</div>';
  h += '<div class="bar-bg"><div class="bar-fill" style="width:' + pct + '%;background:' + (pct === 100 ? '#22c55e' : '#3b82f6') + '"></div></div>';

  // Add task
  h += '<div class="panel"><div class="row">';
  h += '<input id="newTask" class="inp-flex" placeholder="Nouvelle t√¢che..." onkeydown="if(event.key===\'Enter\')addTask()">';
  h += '<button class="btn-add" onclick="addTask()">+</button></div>';
  h += '<div class="row">';
  h += '<select id="newPriority">' + priOpts + '</select>';
  h += '<select id="newCategory">' + catOpts + '</select>';
  h += '<button onclick="showAddCat()" style="padding:6px 10px;background:#334155;color:#94a3b8;font-size:11px;border-radius:8px">+ Cat.</button>';
  if (state.showNewCat) {
    h += '<input id="newCatName" placeholder="Nom..." style="width:90px;font-size:11px" onkeydown="if(event.key===\'Enter\')addCategory()">';
    h += '<button class="btn-sm" style="background:#22c55e" onclick="addCategory()">OK</button>';
  }
  h += '<select id="newAssignee">' + userOpts + '</select>';
  h += '<input type="date" id="newDue" style="font-size:12px">';
  h += '</div></div>';

  // Filters
  h += '<div class="row" style="margin-bottom:8px">';
  for (var i = 0; i < FILTERS.length; i++) {
    var f = FILTERS[i];
    h += '<button class="btn-filter ' + (state.filter === f ? 'active' : '') + '" onclick="setFilter(\'' + f + '\')">' + f + '</button>';
  }
  h += '</div>';

  h += '<div class="cat-filters">';
  for (var i = 0; i < usedCats.length; i++) h += '<button class="btn-cat ' + (state.catFilter === usedCats[i] ? 'active' : '') + '" onclick="setCatFilter(\'' + escQuote(usedCats[i]) + '\')">' + esc(usedCats[i]) + '</button>';
  h += '</div>';

  h += '<div class="person-filters">';
  for (var i = 0; i < allPeople.length; i++) {
    var p = allPeople[i];
    var label = p === "Toutes" ? "üë• Tous" : getUserName(p);
    h += '<button class="btn-person ' + (state.personFilter === p ? 'active' : '') + '" onclick="setPersonFilter(\'' + p + '\')">' + esc(label) + '</button>';
  }
  h += '</div>';

  // Bulk actions
  var filteredDone = 0;
  for (var i = 0; i < filtered.length; i++) { if (filtered[i].done) filteredDone++; }
  var filteredNotDone = filtered.length - filteredDone;

  if (filtered.length > 0) {
    h += '<div class="bulk-bar">';
    if (filteredNotDone > 0) h += '<button class="btn-bulk" style="background:#22c55e" onclick="selectAll()">‚úÖ Tout s√©lectionner (' + filteredNotDone + ')</button>';
    if (filteredDone > 0) h += '<button class="btn-bulk" style="background:#f59e0b" onclick="deselectAll()">‚Ü©Ô∏è Tout d√©s√©lectionner (' + filteredDone + ')</button>';
    h += '<span class="bulk-info">' + filtered.length + ' t√¢ches affich√©es</span>';
    h += '</div>';
  }

  // Pagination
  var totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if (state.page >= totalPages) state.page = totalPages - 1;
  if (state.page < 0) state.page = 0;
  var pageStart = state.page * PAGE_SIZE;
  var pageEnd = Math.min(pageStart + PAGE_SIZE, filtered.length);
  var paged = filtered.slice(pageStart, pageEnd);

  if (filtered.length > PAGE_SIZE) {
    h += '<div class="pagination">';
    h += '<button ' + (state.page === 0 ? 'disabled' : '') + ' onclick="goPage(0)">&laquo;</button>';
    h += '<button ' + (state.page === 0 ? 'disabled' : '') + ' onclick="goPage(' + (state.page - 1) + ')">&lsaquo; Pr√©c.</button>';
    h += '<span>Page ' + (state.page + 1) + ' / ' + totalPages + '</span>';
    h += '<button ' + (state.page >= totalPages - 1 ? 'disabled' : '') + ' onclick="goPage(' + (state.page + 1) + ')">Suiv. &rsaquo;</button>';
    h += '<button ' + (state.page >= totalPages - 1 ? 'disabled' : '') + ' onclick="goPage(' + (totalPages - 1) + ')">&raquo;</button>';
    h += '</div>';
  }

  // Tasks
  if (filtered.length === 0) h += '<div class="empty">Aucune t√¢che pour ces filtres üîç</div>';

  for (var i = 0; i < paged.length; i++) {
    var t = paged[i];
    var od = isOverdue(t), ds = isDueSoon(t);
    var isEdit = state.editId === t._id;
    var commOpen = state.commentOpenId === t._id;
    var comments = t.comments || {};
    var commArr = [];
    for (var ck in comments) { var cv = comments[ck]; cv._id = ck; commArr.push(cv); }
    commArr.sort(function(a, b) { return new Date(a.at) - new Date(b.at); });

    h += '<div class="task ' + (t.done ? 'done' : '') + ' ' + (od ? 'overdue' : '') + '">';
    h += '<div class="task-main">';
    h += '<div class="check ' + (t.done ? 'checked' : '') + '" onclick="toggleTask(\'' + t._id + '\')">' + (t.done ? '‚úì' : '') + '</div>';
    h += '<div class="task-body">';

    if (isEdit) {
      h += '<input id="editText" value="' + esc(t.text) + '" onkeydown="if(event.key===\'Enter\')saveEdit(\'' + t._id + '\')" style="width:100%;background:#0f172a">';
      h += '<div class="edit-row">';
      var eCatOpts = "";
      for (var j = 0; j < state.categories.length; j++) eCatOpts += '<option value="' + esc(state.categories[j]) + '" ' + (state.categories[j] === t.category ? 'selected' : '') + '>' + esc(state.categories[j]) + '</option>';
      var eUserOpts = '<option value="">Non assign√©e</option>';
      for (var uid in state.users) eUserOpts += '<option value="' + uid + '" ' + (t.assignee === uid ? 'selected' : '') + '>' + esc(state.users[uid].name) + '</option>';
      h += '<select id="editCat">' + eCatOpts + '</select>';
      h += '<select id="editAssignee">' + eUserOpts + '</select>';
      h += '<input type="date" id="editDue" value="' + (t.dueDate || '') + '">';
      h += '<button class="btn-sm" style="background:#3b82f6" onclick="saveEdit(\'' + t._id + '\')">OK</button>';
      h += '<button class="btn-sm" style="background:#334155" onclick="cancelEdit()">‚úï</button>';
      h += '</div>';
    } else {
      h += '<div ' + (!t.done ? 'onclick="startEdit(\'' + t._id + '\')" style="cursor:pointer"' : '') + '>';
      h += '<span class="task-title ' + (t.done ? 'crossed' : '') + '">' + esc(t.text) + '</span>';
      h += '<div class="task-meta">';
      h += '<span class="badge-cat">' + esc(t.category) + '</span>';
      h += '<span>' + PRIORITIES[t.priority] + '</span>';
      if (t.assignee) h += '<span class="badge-person">üë§ ' + esc(getUserName(t.assignee)) + '</span>';
      if (t.dueDate) h += '<span class="badge-date ' + (od ? 'overdue' : ds ? 'soon' : '') + '">üìÖ ' + fmtDate(t.dueDate) + (od ? ' ‚ö†Ô∏è' : '') + '</span>';
      h += '<span>par ' + esc(getUserName(t.createdBy)) + '</span>';
      if (t.done && t.completedBy) h += '<span style="color:#22c55e">‚úì ' + esc(getUserName(t.completedBy)) + '</span>';
      if (commArr.length > 0) h += '<span>üí¨ ' + commArr.length + '</span>';
      h += '</div></div>';
    }

    h += '</div>';
    h += '<div style="display:flex;gap:4px;flex-shrink:0;margin-top:2px">';
    h += '<button class="btn-edit" onclick="toggleComments(\'' + t._id + '\')">üí¨</button>';
    h += '<button class="btn-del" onclick="removeTask(\'' + t._id + '\')">‚úï</button>';
    h += '</div></div>';

    if (commOpen) {
      h += '<div class="comment-section">';
      for (var j = 0; j < commArr.length; j++) {
        var c = commArr[j];
        h += '<div class="comment"><div class="comment-meta">üë§ ' + esc(getUserName(c.author)) + ' ¬∑ ' + fmtFull(c.at) + '</div><div class="comment-text">' + esc(c.text) + '</div></div>';
      }
      h += '<div style="display:flex;gap:6px;margin-top:6px">';
      h += '<input id="cmtIn' + t._id + '" placeholder="Ajouter un commentaire..." style="flex:1;font-size:12px;background:#1e293b" onkeydown="if(event.key===\'Enter\')addComment(\'' + t._id + '\')">';
      h += '<button class="btn-sm" style="background:#3b82f6" onclick="addComment(\'' + t._id + '\')">Envoyer</button>';
      h += '</div></div>';
    }
    h += '</div>';
  }

  // Pagination bas
  if (filtered.length > PAGE_SIZE) {
    h += '<div class="pagination">';
    h += '<button ' + (state.page === 0 ? 'disabled' : '') + ' onclick="goPage(0)">&laquo;</button>';
    h += '<button ' + (state.page === 0 ? 'disabled' : '') + ' onclick="goPage(' + (state.page - 1) + ')">&lsaquo; Pr√©c.</button>';
    h += '<span>Page ' + (state.page + 1) + ' / ' + totalPages + '</span>';
    h += '<button ' + (state.page >= totalPages - 1 ? 'disabled' : '') + ' onclick="goPage(' + (state.page + 1) + ')">Suiv. &rsaquo;</button>';
    h += '<button ' + (state.page >= totalPages - 1 ? 'disabled' : '') + ' onclick="goPage(' + (totalPages - 1) + ')">&raquo;</button>';
    h += '</div>';
  }

  app.innerHTML = h;
}

function renderLogin(app) {
  var isReg = state.loginMode === "register";
  var h = '<div class="login-wrap"><div class="login-box">';
  h += '<div style="font-size:48px;margin-bottom:12px">' + (isReg ? 'üìù' : 'üîê') + '</div>';
  h += '<h1 style="font-size:24px;margin-bottom:8px">' + (isReg ? 'Cr√©er un compte' : 'Connexion') + '</h1>';
  h += '<p style="color:#94a3b8;font-size:14px;margin-bottom:24px">Acc√®de aux t√¢ches de ton √©quipe</p>';
  if (state.loginErr) h += '<div class="login-err">' + esc(state.loginErr) + '</div>';
  if (isReg) h += '<input id="loginName" placeholder="Ton pr√©nom..." onkeydown="if(event.key===\'Enter\')document.getElementById(\'loginEmail\').focus()">';
  h += '<input id="loginEmail" type="email" placeholder="Email..." onkeydown="if(event.key===\'Enter\')document.getElementById(\'loginPass\').focus()">';
  h += '<input id="loginPass" type="password" placeholder="Mot de passe..." onkeydown="if(event.key===\'Enter\')' + (isReg ? 'doRegister()' : 'doLogin()') + '">';
  h += '<button onclick="' + (isReg ? 'doRegister()' : 'doLogin()') + '" style="background:#3b82f6;color:#fff;margin-bottom:12px">' + (isReg ? "S'inscrire" : 'Se connecter') + '</button>';
  h += '<p style="color:#64748b;font-size:12px;cursor:pointer" onclick="setLoginMode(\'' + (isReg ? 'login' : 'register') + '\')">';
  h += isReg ? 'D√©j√† un compte ? <span style="color:#3b82f6">Se connecter</span>' : 'Pas de compte ? <span style="color:#3b82f6">Cr√©er un compte</span>';
  h += '</p></div></div>';
  app.innerHTML = h;
  setTimeout(function() { var i = document.getElementById(isReg ? "loginName" : "loginEmail"); if (i) i.focus(); }, 50);
}
</script>
</body>
</html>
